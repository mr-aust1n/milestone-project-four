{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<h1 aria-label="Your Listed Items">My Listings</h1>

{% if my_items %}
<div class="dashboard-grid">
    {% for item in my_items %}
    <div class="item-card">
        <div class="item-image-wrapper">
            {% if item.image %}
            <img src="{{ item.secure_image_url }}" alt="{{ item.title }}">
            {% endif %}
        </div>
        <div class="item-info">
            <h3 class="item-title">{{ item.title }}</h3>
            <p><strong>£{{ item.price }}</strong></p>
            <p>Available: {{ item.quantity }}</p>
            <p>{{ item.description|truncatewords:20 }}</p>
            <div class="item-actions">
                <a href="{% url 'item_detail' item.id %}">View</a> |
                <a href="{% url 'edit_item' item.id %}">Edit</a> |
                <a href="{% url 'delete_item' item.id %}">Delete</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>You haven't listed any items yet.</p>
{% endif %}

<hr>

<h3>Offers Received</h3>
{% if offers %}
<div class="dashboard-grid">
    {% for offer in offers %}
    <div class="offer-card" role="region" aria-label="Offer from {{ offer.buyer.username }}">
        <div class="offer-header">
            <strong>{{ offer.item.title }}</strong><br>
            <span>£{{ offer.price }} from {{ offer.buyer.username }}</span>
        </div>
        <p class="offer-meta">{{ offer.created_at|date:"M d, Y H:i" }}</p>
        <p class="offer-note"><em>{{ offer.offer_note }}</em></p>

        {% if offer.status == "pending" %}
        <form action="{% url 'accept_offer' offer.id %}" method="post">
            {% csrf_token %}
            <button type="submit" class="offer-action"
                aria-label="Accept offer from {{ offer.buyer.username }}">Accept</button>
        </form>
        <form action="{% url 'reject_offer' offer.id %}" method="post">
            {% csrf_token %}
            <button type="submit" class="offer-action"
                aria-label="Reject offer from {{ offer.buyer.username }}">Reject</button>
        </form>
        {% else %}
        <p>Status: <strong>{{ offer.status|title }}</strong></p>
        {% endif %}
    </div>
    {% endfor %}
</div>


{% else %}
<p>No offers submitted yet.</p>
{% endif %}

<hr>

<h3>Messages Received</h3>
{% if messages %}
<div class="dashboard-grid">
    {% for msg in messages %}
    <div class="message-card" role="region" aria-label="Message from {{ msg.sender.username }}">
        <div class="message-header">
            <strong>{{ msg.sender.username }}</strong> →
            <a href="{% url 'item_detail' msg.item.id %}">{{ msg.item.title }}</a>
        </div>
        <p class="message-meta">{{ msg.created_at|date:"M d, Y H:i" }}</p>
        <p class="message-body">{{ msg.message }}</p>
        <form action="{% url 'dismiss_message' msg.id %}" method="post" style="margin-top: 10px;">
            {% csrf_token %}
            <button type="submit" aria-label="Dismiss message from {{ msg.sender.username }}">Dismiss</button>
        </form>
    </div>
    {% endfor %}
</div>

{% else %}
<p>No messages received yet.</p>
{% endif %}
{% endblock %}